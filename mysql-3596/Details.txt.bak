
Acknowledge: Shan Lu (shanlu@cs.wisc.edu)

+--------------------+
|                    |
| SUMMARY            |
|                    |
+--------------------+

A concurrency bug in MySQL-4.0.19

This is a data race and a single-variable atomicity
violation bug.

+---------------------------------------------------------+
|                                                         |
| DETAILS                                                 |
|                                                         |
+---------------------------------------------------------+

Some details can also be found at:
http://bugs.mysql.com/bug.php?id=3596

The function first check whether thd->proc_info is NULL or
not. If not, the function will write the info to output.
However, the check and the use is not protected by any
synchronization primitives, it is possible that
thd->proc_info is nullified by other threads between the
check and the use, leading to a server crash.

The buggy interleaving is as follows:

Thread 1                         Thread 2

void ...print_thd(..)            bool do_command(...) {
{
  if (thd->proc_info) {
    putc(' ', f);
                                   thd->proc_info = 0;

    fputs(thd->proc_info, f);
  }
}                                }

(in sql/ha_innodb.cc)            (in sql/sql_parse.cc)


This interleaving will cause MySQL server being restarted.

